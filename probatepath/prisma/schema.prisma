generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MatterStatus {
  DRAFT
  INTAKE
  REVIEW
  PACK_READY
  MAILED
  DEFECT
  DONE
}

enum PackStatus {
  DRAFT
  READY
}

enum WillSearchStatus {
  READY
  GENERATED
  SENT
}

enum BeneficiaryType {
  SPOUSE
  CHILD
  STEPCHILD
  GRANDCHILD
  PARENT
  SIBLING
  OTHER_FAMILY
  CHARITY
  OTHER
}

enum BeneficiaryStatus {
  ALIVE
  DECEASED_BEFORE_WILL
  DECEASED_AFTER_WILL
  UNKNOWN
}

enum ScheduleKind {
  EXECUTORS
  BENEFICIARIES
  MINORS
  DECEASED_BENEFICIARIES
  FOREIGN_ASSETS
  IRREGULARITIES
  NOTICES
  OTHER
}

enum RightFitStatus {
  UNKNOWN
  ELIGIBLE
  NOT_FIT
}

enum Role {
  USER
  ADMIN
}

enum PortalStatus {
  intake_complete
  will_search_prepping
  will_search_ready
  will_search_sent
  notices_in_progress
  notices_waiting_21_days
  probate_package_prepping
  probate_package_ready
  probate_filing_ready
  probate_filing_in_progress
  probate_filed
  waiting_for_grant
  grant_complete
  done
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  passwordHash  String?
  role          Role      @default(USER)
  accounts      Account[]
  sessions      Session[]
  matters       Matter[]
  authLogs      AuthAuditLog[]
  audits        AuditLog[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Matter {
  id         String          @id @default(cuid())
  caseCode   String?         @unique
  userId     String?
  user       User?           @relation(fields: [userId], references: [id])
  clientKey  String          @unique
  portalStatus PortalStatus  @default(intake_complete)
  willSearchStatus String    @default("not_started")
  p1Status          String   @default("not_started")
  probateStatus     String   @default("not_started")
  status     MatterStatus    @default(DRAFT)
  rightFitStatus    RightFitStatus @default(UNKNOWN)
  rightFitCompletedAt DateTime?
  rightFitAnswers    Json?
  draft      IntakeDraft?
  pack       GeneratedPack?
  files      File[]
  audits     AuditLog[]
  emails     EmailLog[]
  willSearch WillSearchRequest[]
  resumeLinks ResumeToken[]
  executors  Executor[]
  beneficiaries Beneficiary[]
  schedules  SupplementalSchedule[]
  journeyStatus Json?
  stepProgress MatterStepProgress[]
  reminders  Reminder[]
  willSearchPackageReady     Boolean @default(false)
  p1NoticesReady             Boolean @default(false)
  standardProbatePackageReady Boolean @default(false)
  p1Mailed                   Boolean @default(false)
  p1MailedAt                 DateTime?
  willSearchPreparedAt       DateTime?
  willSearchMailedAt         DateTime?
  noticesPreparedAt          DateTime?
  noticesMailedAt            DateTime?
  probatePackagePreparedAt   DateTime?
  probateFiledAt             DateTime?
  grantIssuedAt              DateTime?
  willSearchPdfUrl           String?
  p1NoticePdfUrl             String?
  p1PacketPdfUrl             String?
  p1CoverLetterPdfUrl        String?
  probatePackagePdfUrl       String?
  registryName               String?
  registryAddress            String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model MatterStepProgress {
  id        String   @id @default(cuid())
  matterId  String
  matter    Matter   @relation(fields: [matterId], references: [id])
  stepKey   String
  status    String   @default("not_started")
  pageIndex Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([matterId, stepKey])
}

model IntakeDraft {
  id                    String   @id @default(cuid())
  matterId              String   @unique
  matter                Matter   @relation(fields: [matterId], references: [id])
  email                 String
  consent               Boolean
  exFullName            String
  exPhone               String?
  exCity                String
  exRelation            String
  decFullName           String
  decDateOfDeath        DateTime
  decCityProv           String
  hadWill               Boolean
  willLocation          String
  estateValueRange      String
  anyRealProperty       Boolean
  multipleBeneficiaries Boolean
  specialCircumstances  String?
  payload               Json?
  submittedAt           DateTime? @db.Timestamptz
  finalSnapshot         Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model WillSearchRequest {
  id                    String   @id @default(cuid())
  matterId              String
  matter                Matter   @relation(fields: [matterId], references: [id])

  executorEmail         String
  executorFullName      String
  executorPhone         String?
  executorCity          String?
  executorRelationship  String?

  deceasedFullName      String
  deceasedGivenNames    String?
  deceasedSurname       String?
  deceasedDateOfDeath   DateTime?
  deceasedCity          String?
  deceasedProvince      String?
  deceasedDateOfBirth   DateTime?
  deceasedPlaceOfBirth  String?
  deceasedMarriedSurname String?
  deceasedAliases       String[]  @default([])

  hasWill               Boolean?
  searchNotes           String?
  mailingPreference     String?
  courierAddress        String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model GeneratedPack {
  id        String     @id @default(cuid())
  matterId  String     @unique
  matter    Matter     @relation(fields: [matterId], references: [id])
  status    PackStatus @default(DRAFT)
  zipUrl    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model File {
  id        String   @id @default(cuid())
  matterId  String
  matter    Matter   @relation(fields: [matterId], references: [id])
  name      String
  mimeType  String
  size      Int
  url       String
  createdAt DateTime @default(now())
}

model EmailLog {
  id        String   @id @default(cuid())
  matterId  String?
  matter    Matter?  @relation(fields: [matterId], references: [id])
  to        String
  subject   String
  template  String
  meta      Json?
  createdAt DateTime @default(now())
}

model ResumeToken {
  token     String   @id
  matterId  String
  matter    Matter   @relation(fields: [matterId], references: [id])
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Reminder {
  id        String   @id @default(cuid())
  case      Matter   @relation(fields: [caseId], references: [id])
  caseId    String
  type      String
  channel   String
  dueAt     DateTime
  sentAt    DateTime?
  createdAt DateTime @default(now())

  @@unique([caseId, type])
  @@index([dueAt, sentAt])
}

model AuditLog {
  id        String   @id @default(cuid())
  matterId  String?
  matter    Matter?  @relation(fields: [matterId], references: [id])
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  actorId   String?
  action    String
  ip        String?
  ua        String?
  meta      Json?
  createdAt DateTime @default(now())
}

enum AuthAuditType {
  REGISTER
  LOGIN
  LOGOUT
}

model AuthAuditLog {
  id        String         @id @default(cuid())
  userId    String?
  user      User?          @relation(fields: [userId], references: [id])
  type      AuthAuditType
  ip        String?
  userAgent String?
  meta      Json?
  createdAt DateTime       @default(now())
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model Executor {
  id           String   @id @default(cuid())
  matterId     String
  matter       Matter   @relation(fields: [matterId], references: [id])

  isPrimary    Boolean  @default(false)
  isAlternate  Boolean  @default(false)
  orderIndex   Int      @default(0)

  fullName     String
  givenNames   String?
  surname      String?
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     String?
  postalCode   String?
  country      String?

  isRenouncing Boolean  @default(false)
  isMinor      Boolean  @default(false)
  isDeceased   Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Beneficiary {
  id                  String           @id @default(cuid())
  matterId            String
  matter              Matter           @relation(fields: [matterId], references: [id])

  type                BeneficiaryType
  status              BeneficiaryStatus @default(ALIVE)

  fullName            String
  givenNames          String?
  surname             String?

  relationshipLabel   String?
  isMinor             Boolean          @default(false)
  dateOfBirth         DateTime?
  addressLine1        String?
  addressLine2        String?
  city                String?
  province            String?
  postalCode          String?
  country             String?

  shareDescription    String?
  notes               String?

  representedById     String?
  representedBy       Beneficiary?     @relation("Representation", fields: [representedById], references: [id])
  representedChildren Beneficiary[]     @relation("Representation")

  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
}

model SupplementalSchedule {
  id          String        @id @default(cuid())
  matterId    String
  matter      Matter        @relation(fields: [matterId], references: [id])

  kind        ScheduleKind
  title       String
  description String?
  sortOrder   Int           @default(0)

  payload     Json

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}
