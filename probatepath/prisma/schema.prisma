generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String         @id @default(cuid())
  email        String         @unique
  name         String?
  image        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  passwordHash String?
  role         Role           @default(USER)
  accounts     Account[]
  audits       AuditLog[]
  authLogs     AuthAuditLog[]
  matters      Matter[]
  sessions     Session[]
}

model Matter {
  id                          String                 @id @default(cuid())
  userId                      String?
  clientKey                   String                 @unique
  status                      MatterStatus           @default(DRAFT)
  createdAt                   DateTime               @default(now())
  updatedAt                   DateTime               @updatedAt
  journeyStatus               Json?
  rightFitStatus              RightFitStatus         @default(UNKNOWN)
  rightFitCompletedAt         DateTime?
  rightFitAnswers             Json?
  p1Mailed                    Boolean                @default(false)
  p1MailedAt                  DateTime?
  p1NoticesReady              Boolean                @default(false)
  portalStatus                PortalStatus           @default(intake_complete)
  standardProbatePackageReady Boolean                @default(false)
  willSearchPackageReady      Boolean                @default(false)
  noticesMailedAt             DateTime?
  noticesPreparedAt           DateTime?
  probateFiledAt              DateTime?
  probatePackagePreparedAt    DateTime?
  willSearchMailedAt          DateTime?
  willSearchPreparedAt        DateTime?
  p1NoticePdfUrl              String?
  probatePackagePdfUrl        String?
  willSearchPdfUrl            String?
  caseCode                    String?                @unique
  p1CoverLetterPdfUrl         String?
  p1Status                    String                 @default("not_started")
  probateStatus               String                 @default("not_started")
  willSearchStatus            String                 @default("not_started")
  grantIssuedAt               DateTime?
  p1PacketPdfUrl              String?
  registryAddress             String?
  registryName                String?
  audits                      AuditLog[]
  beneficiaries               Beneficiary[]
  emails                      EmailLog[]
  executors                   Executor[]
  files                       File[]
  pack                        GeneratedPack?
  draft                       IntakeDraft?
  user                        User?                  @relation(fields: [userId], references: [id])
  stepProgress                MatterStepProgress[]
  reminders                   Reminder[]
  resumeLinks                 ResumeToken[]
  schedules                   SupplementalSchedule[]
  willSearch                  WillSearchRequest[]
  willFiles                   WillFile[]
}

model MatterStepProgress {
  id        String   @id @default(cuid())
  matterId  String
  stepKey   String
  status    String   @default("not_started")
  pageIndex Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  matter    Matter   @relation(fields: [matterId], references: [id])

  @@unique([matterId, stepKey])
}

model IntakeDraft {
  id                    String    @id @default(cuid())
  matterId              String    @unique
  email                 String
  consent               Boolean
  exFullName            String
  exPhone               String?
  exCity                String
  exRelation            String
  decFullName           String
  decDateOfDeath        DateTime
  decCityProv           String
  hadWill               Boolean
  willLocation          String
  estateValueRange      String
  anyRealProperty       Boolean
  multipleBeneficiaries Boolean
  specialCircumstances  String?
  payload               Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  finalSnapshot         Json?
  submittedAt           DateTime? @db.Timestamptz(6)
  matter                Matter    @relation(fields: [matterId], references: [id])
}

model WillSearchRequest {
  id                     String    @id @default(cuid())
  matterId               String
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  courierAddress         String?
  deceasedCity           String?
  deceasedDateOfDeath    DateTime?
  deceasedFullName       String
  deceasedGivenNames     String?
  deceasedProvince       String?
  deceasedSurname        String?
  executorCity           String?
  executorEmail          String
  executorFullName       String
  executorPhone          String?
  executorRelationship   String?
  hasWill                Boolean?
  mailingPreference      String?
  searchNotes            String?
  deceasedAliases        String[]  @default([])
  deceasedDateOfBirth    DateTime?
  deceasedPlaceOfBirth   String?
  deceasedMarriedSurname String?
  matter                 Matter    @relation(fields: [matterId], references: [id])
}

model GeneratedPack {
  id        String     @id @default(cuid())
  matterId  String     @unique
  status    PackStatus @default(DRAFT)
  zipUrl    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  matter    Matter     @relation(fields: [matterId], references: [id])
}

model File {
  id        String   @id @default(cuid())
  matterId  String
  name      String
  mimeType  String
  size      Int
  url       String
  createdAt DateTime @default(now())
  matter    Matter   @relation(fields: [matterId], references: [id])
}

model EmailLog {
  id        String   @id @default(cuid())
  matterId  String?
  to        String
  subject   String
  template  String
  meta      Json?
  createdAt DateTime @default(now())
  matter    Matter?  @relation(fields: [matterId], references: [id])
}

model ResumeToken {
  token     String   @id
  matterId  String
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  matter    Matter   @relation(fields: [matterId], references: [id])
}

model Reminder {
  id        String    @id @default(cuid())
  caseId    String
  type      String
  channel   String
  dueAt     DateTime
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  case      Matter    @relation(fields: [caseId], references: [id])

  @@unique([caseId, type])
  @@index([dueAt, sentAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  matterId     String?
  actorId      String?
  action       String
  meta         Json?
  createdAt    DateTime @default(now())
  ip           String?
  ua           String?
  userId       String?
  resourceType String?
  resourceId   String?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  matter       Matter?  @relation(fields: [matterId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model AuthAuditLog {
  id        String        @id @default(cuid())
  userId    String?
  type      AuthAuditType
  ip        String?
  userAgent String?
  meta      Json?
  createdAt DateTime      @default(now())
  user      User?         @relation(fields: [userId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Executor {
  id           String   @id @default(cuid())
  matterId     String
  isPrimary    Boolean  @default(false)
  isAlternate  Boolean  @default(false)
  orderIndex   Int      @default(0)
  fullName     String
  givenNames   String?
  surname      String?
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     String?
  postalCode   String?
  country      String?
  isRenouncing Boolean  @default(false)
  isMinor      Boolean  @default(false)
  isDeceased   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  matter       Matter   @relation(fields: [matterId], references: [id])
}

model Beneficiary {
  id                  String            @id @default(cuid())
  matterId            String
  type                BeneficiaryType
  status              BeneficiaryStatus @default(ALIVE)
  fullName            String
  givenNames          String?
  surname             String?
  relationshipLabel   String?
  isMinor             Boolean           @default(false)
  dateOfBirth         DateTime?
  addressLine1        String?
  addressLine2        String?
  city                String?
  province            String?
  postalCode          String?
  country             String?
  shareDescription    String?
  notes               String?
  representedById     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  matter              Matter            @relation(fields: [matterId], references: [id])
  representedBy       Beneficiary?      @relation("Representation", fields: [representedById], references: [id])
  representedChildren Beneficiary[]     @relation("Representation")
}

model SupplementalSchedule {
  id          String       @id @default(cuid())
  matterId    String
  kind        ScheduleKind
  title       String
  description String?
  sortOrder   Int          @default(0)
  payload     Json
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  matter      Matter       @relation(fields: [matterId], references: [id])
}

model DisclaimerAcceptance {
  id             String   @id @default(cuid())
  userId         String?
  disclaimerType String
  ipAddress      String?
  userAgent      String?
  acceptedAt     DateTime @default(now())

  @@index([userId])
}

model WillExtraction {
  id                 String   @id @default(cuid())
  userId             String
  uploadId           String
  testatorName       String?
  willDate           String?
  executors          Json?
  beneficiaries      Json?
  hasCodicils        Boolean?
  handwrittenChanges Boolean?
  issues             Json?
  rawText            String?
  extractedAt        DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([uploadId])
  @@index([userId])
}

model WillUpload {
  id          String    @id @default(cuid())
  userId      String
  estateId    String?
  fileName    String
  fileType    String
  fileSize    Int
  storagePath String
  uploadedAt  DateTime  @default(now())
  expiresAt   DateTime
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([expiresAt])
  @@index([userId])
}

model WillFile {
  id               String       @id @default(cuid())
  matterId         String
  fileUrl          String
  fileType         WillFileType
  originalFilename String
  pageIndex        Int?
  uploadedBy       String?
  createdAt        DateTime     @default(now())
  matter           Matter       @relation(fields: [matterId], references: [id])

  @@index([matterId])
  @@index([matterId, fileType])
}

enum MatterStatus {
  DRAFT
  INTAKE
  REVIEW
  PACK_READY
  MAILED
  DEFECT
  DONE
}

enum PackStatus {
  DRAFT
  READY
}

enum WillSearchStatus {
  READY
  GENERATED
  SENT
}

enum WillFileType {
  pdf
  image
}

enum BeneficiaryType {
  SPOUSE
  CHILD
  STEPCHILD
  GRANDCHILD
  PARENT
  SIBLING
  OTHER_FAMILY
  CHARITY
  OTHER
}

enum BeneficiaryStatus {
  ALIVE
  DECEASED_BEFORE_WILL
  DECEASED_AFTER_WILL
  UNKNOWN
}

enum ScheduleKind {
  EXECUTORS
  BENEFICIARIES
  MINORS
  DECEASED_BENEFICIARIES
  FOREIGN_ASSETS
  IRREGULARITIES
  NOTICES
  OTHER
}

enum RightFitStatus {
  UNKNOWN
  ELIGIBLE
  NOT_FIT
}

enum Role {
  USER
  ADMIN
}

enum PortalStatus {
  intake_complete
  will_search_prepping
  will_search_ready
  will_search_sent
  notices_in_progress
  notices_waiting_21_days
  probate_package_prepping
  probate_package_ready
  probate_filing_ready
  probate_filing_in_progress
  probate_filed
  waiting_for_grant
  grant_complete
  done
}

enum AuthAuditType {
  REGISTER
  LOGIN
  LOGOUT
}
