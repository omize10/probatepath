generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String?
  image               String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  passwordHash        String?
  role                Role                 @default(USER)
  selectedTier        Tier?
  intakeMethod        String?
  isPremium           Boolean              @default(false)
  phone               String?
  createdVia          String?              @map("created_via")
  accounts            Account[]
  audits              AuditLog[]
  authLogs            AuthAuditLog[]
  matters             Matter[]
  sessions            Session[]
  tierSelections      TierSelection[]
  betaPayments        BetaPayment[]
  callbackSchedules   CallbackSchedule[]
  callbackWillUploads CallbackWillUpload[]
  notifications       Notification[]
  matterNotes         MatterNote[]
  aiCalls             AiCall[]
  paymentTokens       PaymentToken[]
  leadSources         LeadSource[]
}

model Matter {
  id                          String                 @id @default(cuid())
  userId                      String?
  clientKey                   String                 @unique
  status                      MatterStatus           @default(DRAFT)
  createdAt                   DateTime               @default(now())
  updatedAt                   DateTime               @updatedAt
  journeyStatus               Json?
  rightFitStatus              RightFitStatus         @default(UNKNOWN)
  rightFitCompletedAt         DateTime?
  rightFitAnswers             Json?
  p1Mailed                    Boolean                @default(false)
  p1MailedAt                  DateTime?
  p1NoticesReady              Boolean                @default(false)
  portalStatus                PortalStatus           @default(intake_complete)
  standardProbatePackageReady Boolean                @default(false)
  willSearchPackageReady      Boolean                @default(false)
  noticesMailedAt             DateTime?
  noticesPreparedAt           DateTime?
  probateFiledAt              DateTime?
  probatePackagePreparedAt    DateTime?
  willSearchMailedAt          DateTime?
  willSearchPreparedAt        DateTime?
  p1NoticePdfUrl              String?
  probatePackagePdfUrl        String?
  willSearchPdfUrl            String?
  caseCode                    String?                @unique
  p1CoverLetterPdfUrl         String?
  p1Status                    String                 @default("not_started")
  probateStatus               String                 @default("not_started")
  willSearchStatus            String                 @default("not_started")
  grantIssuedAt               DateTime?
  p1PacketPdfUrl              String?
  registryAddress             String?
  registryName                String?
  // Path type: probate (with will) or administration (no will)
  pathType                    String                 @default("probate")
  // AI intake tracking
  intakeSource                String?                @map("intake_source")
  aiCallId                    String?                @map("ai_call_id")
  aiCall                      AiCall?                @relation(fields: [aiCallId], references: [id])
  // Will search certificate tracking
  willSearchCertificateUrl         String?
  willSearchCertificateUploadedAt  DateTime?
  willSearchCertificateVerified    Boolean            @default(false)
  // Court filing tracking
  courtFileNumber                  String?
  grantDocumentUrl                 String?
  grantUploadedAt                  DateTime?
  // Relations
  audits                      AuditLog[]
  beneficiaries               Beneficiary[]
  emails                      EmailLog[]
  executors                   Executor[]
  files                       File[]
  pack                        GeneratedPack?
  draft                       IntakeDraft?
  user                        User?                  @relation(fields: [userId], references: [id])
  stepProgress                MatterStepProgress[]
  reminders                   Reminder[]
  resumeLinks                 ResumeToken[]
  schedules                   SupplementalSchedule[]
  willSearch                  WillSearchRequest[]
  willFiles                   WillFile[]
  formsPackageGeneratedAt     DateTime?
  formsPackageUrl             String?
  formsGenerated              String[]
  formData                    Json?
  beneficiaryMailings         BeneficiaryMailing[]
  notifications               Notification[]
  postGrantAssets             PostGrantAsset[]
  postGrantDebts              PostGrantDebt[]
  distributions               Distribution[]
  beneficiaryReleases         BeneficiaryRelease[]
  requisitions                Requisition[]
  notes                       MatterNote[]
  flags                       MatterFlag[]
  intestateHeirs              IntestateHeir[]
  smsLogs                     SmsLog[]
  milestoneConfirmations      MilestoneConfirmation[]
}

model MatterStepProgress {
  id        String   @id @default(cuid())
  matterId  String
  stepKey   String
  status    String   @default("not_started")
  pageIndex Int      @default(0)
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  matter    Matter   @relation(fields: [matterId], references: [id])

  @@unique([matterId, stepKey])
}

model IntakeDraft {
  id                    String    @id @default(cuid())
  matterId              String    @unique
  email                 String
  consent               Boolean
  exFullName            String
  exPhone               String?
  exCity                String
  exRelation            String
  decFullName           String
  decDateOfDeath        DateTime
  decCityProv           String
  hadWill               Boolean
  willLocation          String
  estateValueRange      String
  anyRealProperty       Boolean
  multipleBeneficiaries Boolean
  specialCircumstances  String?
  payload               Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  finalSnapshot         Json?
  submittedAt           DateTime? @db.Timestamptz(6)
  matter                Matter    @relation(fields: [matterId], references: [id])
}

model WillSearchRequest {
  id                     String    @id @default(cuid())
  matterId               String
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  courierAddress         String?
  deceasedCity           String?
  deceasedDateOfDeath    DateTime?
  deceasedFullName       String
  deceasedGivenNames     String?
  deceasedProvince       String?
  deceasedSurname        String?
  executorCity           String?
  executorEmail          String
  executorFullName       String
  executorPhone          String?
  executorRelationship   String?
  hasWill                Boolean?
  mailingPreference      String?
  searchNotes            String?
  deceasedAliases        String[]  @default([])
  deceasedDateOfBirth    DateTime?
  deceasedPlaceOfBirth   String?
  deceasedMarriedSurname String?
  matter                 Matter    @relation(fields: [matterId], references: [id])
}

model GeneratedPack {
  id        String     @id @default(cuid())
  matterId  String     @unique
  status    PackStatus @default(DRAFT)
  zipUrl    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  matter    Matter     @relation(fields: [matterId], references: [id])
}

model File {
  id        String   @id @default(cuid())
  matterId  String
  name      String
  mimeType  String
  size      Int
  url       String
  createdAt DateTime @default(now())
  matter    Matter   @relation(fields: [matterId], references: [id])
}

model EmailLog {
  id        String   @id @default(cuid())
  matterId  String?
  to        String
  subject   String
  template  String
  meta      Json?
  createdAt DateTime @default(now())
  matter    Matter?  @relation(fields: [matterId], references: [id])
}

model ResumeToken {
  token     String   @id
  matterId  String
  email     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  matter    Matter   @relation(fields: [matterId], references: [id])
}

model Reminder {
  id        String    @id @default(cuid())
  caseId    String
  type      String
  channel   String
  dueAt     DateTime
  sentAt    DateTime?
  createdAt DateTime  @default(now())
  case      Matter    @relation(fields: [caseId], references: [id])

  @@unique([caseId, type])
  @@index([dueAt, sentAt])
}

model AuditLog {
  id           String   @id @default(cuid())
  matterId     String?
  actorId      String?
  action       String
  meta         Json?
  createdAt    DateTime @default(now())
  ip           String?
  ua           String?
  userId       String?
  resourceType String?
  resourceId   String?
  metadata     Json?
  ipAddress    String?
  userAgent    String?
  matter       Matter?  @relation(fields: [matterId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
}

model AuthAuditLog {
  id        String        @id @default(cuid())
  userId    String?
  type      AuthAuditType
  ip        String?
  userAgent String?
  meta      Json?
  createdAt DateTime      @default(now())
  user      User?         @relation(fields: [userId], references: [id])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  expires      DateTime
  sessionToken String   @unique
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Executor {
  id           String   @id @default(cuid())
  matterId     String
  isPrimary    Boolean  @default(false)
  isAlternate  Boolean  @default(false)
  orderIndex   Int      @default(0)
  fullName     String
  givenNames   String?
  surname      String?
  email        String?
  phone        String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  province     String?
  postalCode   String?
  country      String?
  isRenouncing Boolean  @default(false)
  isMinor      Boolean  @default(false)
  isDeceased   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  matter       Matter   @relation(fields: [matterId], references: [id])
}

model Beneficiary {
  id                  String            @id @default(cuid())
  matterId            String
  type                BeneficiaryType
  status              BeneficiaryStatus @default(ALIVE)
  fullName            String
  givenNames          String?
  surname             String?
  relationshipLabel   String?
  isMinor             Boolean           @default(false)
  dateOfBirth         DateTime?
  addressLine1        String?
  addressLine2        String?
  city                String?
  province            String?
  postalCode          String?
  country             String?
  shareDescription    String?
  notes               String?
  representedById     String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  matter              Matter            @relation(fields: [matterId], references: [id])
  representedBy       Beneficiary?      @relation("Representation", fields: [representedById], references: [id])
  representedChildren Beneficiary[]     @relation("Representation")
}

model SupplementalSchedule {
  id          String       @id @default(cuid())
  matterId    String
  kind        ScheduleKind
  title       String
  description String?
  sortOrder   Int          @default(0)
  payload     Json
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  matter      Matter       @relation(fields: [matterId], references: [id])
}

model DisclaimerAcceptance {
  id             String   @id @default(cuid())
  userId         String?
  disclaimerType String
  ipAddress      String?
  userAgent      String?
  acceptedAt     DateTime @default(now())

  @@index([userId])
}

model WillExtraction {
  id                 String   @id @default(cuid())
  userId             String
  uploadId           String
  testatorName       String?
  willDate           String?
  executors          Json?
  beneficiaries      Json?
  hasCodicils        Boolean?
  handwrittenChanges Boolean?
  issues             Json?
  rawText            String?
  extractedAt        DateTime @default(now())
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([uploadId])
  @@index([userId])
}

model WillUpload {
  id          String    @id @default(cuid())
  userId      String
  estateId    String?
  fileName    String
  fileType    String
  fileSize    Int
  storagePath String
  uploadedAt  DateTime  @default(now())
  expiresAt   DateTime
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([expiresAt])
  @@index([userId])
}

model WillFile {
  id               String       @id @default(cuid())
  matterId         String
  fileUrl          String
  fileType         WillFileType
  originalFilename String
  pageIndex        Int?
  uploadedBy       String?
  createdAt        DateTime     @default(now())
  matter           Matter       @relation(fields: [matterId], references: [id])

  @@index([matterId])
  @@index([matterId, fileType])
}

enum MatterStatus {
  DRAFT
  INTAKE
  REVIEW
  PACK_READY
  MAILED
  DEFECT
  DONE
}

enum PackStatus {
  DRAFT
  READY
}

enum WillSearchStatus {
  READY
  GENERATED
  SENT
}

enum WillFileType {
  pdf
  image
}

enum BeneficiaryType {
  SPOUSE
  CHILD
  STEPCHILD
  GRANDCHILD
  PARENT
  SIBLING
  OTHER_FAMILY
  CHARITY
  OTHER
}

enum BeneficiaryStatus {
  ALIVE
  DECEASED_BEFORE_WILL
  DECEASED_AFTER_WILL
  UNKNOWN
}

enum ScheduleKind {
  EXECUTORS
  BENEFICIARIES
  MINORS
  DECEASED_BENEFICIARIES
  FOREIGN_ASSETS
  IRREGULARITIES
  NOTICES
  OTHER
}

enum RightFitStatus {
  UNKNOWN
  ELIGIBLE
  NOT_FIT
}

enum Role {
  USER
  ADMIN
}

enum PortalStatus {
  intake_complete
  will_search_prepping
  will_search_ready
  will_search_sent
  notices_in_progress
  notices_waiting_21_days
  probate_package_prepping
  probate_package_ready
  probate_filing_ready
  probate_filing_in_progress
  probate_filed
  waiting_for_grant
  grant_complete
  post_grant_active
  estate_closeout
  done
}

enum AuthAuditType {
  REGISTER
  LOGIN
  LOGOUT
}

// ========================================
// PRICING FLOW MODELS
// ========================================

enum Tier {
  basic
  standard
  premium
}

enum CallbackStatus {
  scheduled
  call_in_progress
  call_complete
  intake_complete
  cancelled
  no_show
}

enum CallbackFileType {
  pdf
  image
}

model TierSelection {
  id             String             @id @default(cuid())
  userId         String
  selectedTier   Tier
  tierPrice      Int
  screeningFlags Json               @default("[]")
  createdAt      DateTime           @default(now())
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  betaPayments   BetaPayment[]
  callbacks      CallbackSchedule[]

  @@index([userId])
}

model BetaPayment {
  id                String        @id @default(cuid())
  userId            String
  tierSelectionId   String
  cardNumberPartial String?
  cardholderName    String?
  billingAddress    String?
  city              String?
  province          String?
  postalCode        String?
  skipped           Boolean       @default(false)
  createdAt         DateTime      @default(now())
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tierSelection     TierSelection @relation(fields: [tierSelectionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tierSelectionId])
}

model CallbackSchedule {
  id                   String              @id @default(cuid())
  userId               String
  tierSelectionId      String
  scheduledDate        DateTime            @db.Date
  scheduledTime        String
  phoneNumber          String
  status               CallbackStatus      @default(scheduled)
  manualIntakeSelected Boolean             @default(false)
  assignedWorker       String?
  callNotes            String?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  tierSelection        TierSelection       @relation(fields: [tierSelectionId], references: [id], onDelete: Cascade)
  willUploads          CallbackWillUpload[]
  retellIntake         RetellIntake?

  @@index([userId])
  @@index([tierSelectionId])
  @@index([status])
  @@index([scheduledDate])
}

model CallbackWillUpload {
  id                 String           @id @default(cuid())
  userId             String
  callbackScheduleId String
  filename           String
  fileType           CallbackFileType
  originalUrl        String
  processedUrl       String?
  thumbnailUrl       String?
  qualityScore       Int?
  qualityWarnings    Json             @default("[]")
  fileSize           Int
  createdAt          DateTime         @default(now())
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  callbackSchedule   CallbackSchedule @relation(fields: [callbackScheduleId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([callbackScheduleId])
}

model RetellIntake {
  id                 String           @id @default(cuid())
  callbackScheduleId String           @unique
  retellCallId       String?
  callDuration       Int?
  recordingUrl       String?
  transcriptUrl      String?
  intakeData         Json
  confidenceScore    Int?
  flaggedFields      Json             @default("[]")
  pushedToEstate     Boolean          @default(false)
  estateId           String?
  createdAt          DateTime         @default(now())
  callbackSchedule   CallbackSchedule @relation(fields: [callbackScheduleId], references: [id], onDelete: Cascade)

  @@index([callbackScheduleId])
}

// ========================================
// AVAILABILITY CALENDAR
// ========================================

model AvailabilitySlot {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  time      String   // e.g., "9:00 AM"
  createdBy String?  // userId of staff who created
  createdAt DateTime @default(now())

  @@unique([date, time])
  @@index([date])
}

// ========================================
// PER-BENEFICIARY P1 MAILING TRACKING
// ========================================

model BeneficiaryMailing {
  id                   String          @id @default(cuid())
  matterId             String
  beneficiaryId        String
  beneficiaryName      String
  beneficiaryAddress   String?
  deliveryMethod       DeliveryMethod  @default(registered_mail)
  status               MailingStatus   @default(not_printed)
  printedAt            DateTime?
  mailedAt             DateTime?
  deliveredAt          DateTime?
  trackingNumber       String?
  carrierName          String?
  notes                String?
  // Confirmation checkboxes for mailing
  confirmedMailedViaRegistered Boolean @default(false)
  confirmedCorrectAddress      Boolean @default(false)
  confirmedUnderstand21Days    Boolean @default(false)
  confirmationsCompletedAt     DateTime?
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  matter               Matter          @relation(fields: [matterId], references: [id])
  proofs               DeliveryProof[]

  @@unique([matterId, beneficiaryId])
  @@index([matterId])
}

model DeliveryProof {
  id                   String             @id @default(cuid())
  beneficiaryMailingId String
  fileUrl              String
  fileName             String
  fileSize             Int?
  uploadedAt           DateTime           @default(now())
  beneficiaryMailing   BeneficiaryMailing @relation(fields: [beneficiaryMailingId], references: [id], onDelete: Cascade)

  @@index([beneficiaryMailingId])
}

enum MailingStatus {
  not_printed
  printed
  mailed
  delivered
}

enum DeliveryMethod {
  registered_mail
  courier
  personal
  electronic
}

// ========================================
// IN-APP NOTIFICATIONS
// ========================================

model Notification {
  id        String           @id @default(cuid())
  matterId  String?
  userId    String
  type      NotificationType
  title     String
  body      String
  href      String?
  readAt    DateTime?
  createdAt DateTime         @default(now())
  matter    Matter?          @relation(fields: [matterId], references: [id])
  user      User             @relation(fields: [userId], references: [id])

  @@index([userId, readAt])
  @@index([userId, createdAt])
}

enum NotificationType {
  document_ready
  countdown_milestone
  action_required
  status_update
  system
}

// ========================================
// POST-GRANT MODULE
// ========================================

model PostGrantAsset {
  id            String      @id @default(cuid())
  matterId      String
  name          String
  category      String
  institution   String?
  accountNumber String?
  estimatedValue Decimal?
  actualValue   Decimal?
  status        AssetStatus @default(identified)
  contactedAt   DateTime?
  documentsSentAt DateTime?
  fundsReceivedAt DateTime?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  matter        Matter      @relation(fields: [matterId], references: [id])

  @@index([matterId])
}

model PostGrantDebt {
  id          String     @id @default(cuid())
  matterId    String
  creditor    String
  category    String?
  amount      Decimal?
  verifiedAmount Decimal?
  status      DebtStatus @default(identified)
  verifiedAt  DateTime?
  paidAt      DateTime?
  receiptUrl  String?
  notes       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  matter      Matter     @relation(fields: [matterId], references: [id])

  @@index([matterId])
}

model Distribution {
  id              String   @id @default(cuid())
  matterId        String
  beneficiaryId   String?
  beneficiaryName String
  sharePercent    Decimal?
  shareAmount     Decimal?
  paidAt          DateTime?
  method          String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  matter          Matter   @relation(fields: [matterId], references: [id])

  @@index([matterId])
}

model BeneficiaryRelease {
  id              String    @id @default(cuid())
  matterId        String
  beneficiaryId   String?
  beneficiaryName String
  sentAt          DateTime?
  signedAt        DateTime?
  fileUrl         String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  matter          Matter    @relation(fields: [matterId], references: [id])

  @@index([matterId])
}

enum AssetStatus {
  identified
  contacted
  documents_sent
  funds_received
  closed
}

enum DebtStatus {
  identified
  verified
  paid
  disputed
}

// ========================================
// REQUISITION HANDLER
// ========================================

model Requisition {
  id          String            @id @default(cuid())
  matterId    String
  receivedAt  DateTime          @default(now())
  dueAt       DateTime?
  status      RequisitionStatus @default(received)
  description String?
  courtNotes  String?
  responseNotes String?
  fileUrl     String?
  responseFileUrl String?
  resolvedAt  DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  matter      Matter            @relation(fields: [matterId], references: [id])

  @@index([matterId])
  @@index([status])
}

enum RequisitionStatus {
  received
  responding
  resolved
}

// ========================================
// OPS NOTES & FLAGS
// ========================================

model MatterNote {
  id        String   @id @default(cuid())
  matterId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  matter    Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([matterId])
  @@index([createdAt])
}

model MatterFlag {
  id          String       @id @default(cuid())
  matterId    String
  flagType    FlagType
  severity    FlagSeverity @default(MEDIUM)
  description String?
  status      FlagStatus   @default(OPEN)
  createdAt   DateTime     @default(now())
  resolvedAt  DateTime?
  resolvedBy  String?
  matter      Matter       @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@index([matterId])
  @@index([status])
  @@index([flagType])
}

enum FlagType {
  NO_ORIGINAL_WILL
  DIFFERENT_WILL_FOUND
  MINOR_BENEFICIARY
  DISABLED_BENEFICIARY
  FOREIGN_ASSETS
  BUSINESS_INTERESTS
  EXPECTED_DISPUTE
  POSSIBLY_INSOLVENT
  PRIORITY_CONFLICT
  COMPLEX_FAMILY
  INTESTATE_CASE
  OTHER
}

enum FlagSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FlagStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

// ========================================
// INTESTATE (ADMINISTRATION) PATH
// ========================================

model IntestateHeir {
  id                    String                @id @default(cuid())
  matterId              String
  fullName              String
  relationship          IntestateRelationship
  isApplicant           Boolean               @default(false)
  hasPriority           Boolean               @default(false)
  renunciationStatus    RenunciationStatus    @default(NOT_NEEDED)
  renunciationReceivedAt DateTime?
  sharePercent          Decimal?              @db.Decimal(5, 2)
  addressLine1          String?
  addressLine2          String?
  city                  String?
  province              String?
  postalCode            String?
  country               String?
  email                 String?
  phone                 String?
  isDeceased            Boolean               @default(false)
  deceasedAt            DateTime?
  notes                 String?
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @default(now()) @updatedAt
  matter                Matter                @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@index([matterId])
  @@index([relationship])
}

enum IntestateRelationship {
  SPOUSE
  CHILD
  GRANDCHILD
  PARENT
  SIBLING
  NIECE_NEPHEW
  OTHER_RELATIVE
}

enum RenunciationStatus {
  NOT_NEEDED
  PENDING
  RECEIVED
  REFUSED
}

// ========================================
// RETELL AI INTAKE
// ========================================

model AiCall {
  id                  String         @id @default(cuid())
  retellCallId        String?        @unique @map("retell_call_id")
  userId              String?        @map("user_id")
  matterId            String?        @map("matter_id")
  phoneNumber         String?        @map("phone_number")
  status              String         @default("in_progress")
  durationSeconds     Int?           @map("duration_seconds")
  recordingUrl        String?        @map("recording_url")
  transcript          String?
  collectedData       Json           @default("{}") @map("collected_data")
  recommendedTier     String?        @map("recommended_tier")
  grantType           String?        @map("grant_type")
  qualificationResult String?        @map("qualification_result")
  qualificationFlags  Json           @default("[]") @map("qualification_flags")
  createdAt           DateTime       @default(now()) @map("created_at")
  endedAt             DateTime?      @map("ended_at")
  user                User?          @relation(fields: [userId], references: [id])
  matters             Matter[]
  paymentTokens       PaymentToken[]
  leadSources         LeadSource[]

  @@index([userId])
  @@index([retellCallId])
  @@index([status])
  @@index([createdAt])
  @@map("ai_calls")
}

model PaymentToken {
  id          String    @id @default(cuid())
  token       String    @unique
  userId      String?   @map("user_id")
  aiCallId    String?   @map("ai_call_id")
  prefillData Json      @default("{}") @map("prefill_data")
  expiresAt   DateTime  @map("expires_at")
  usedAt      DateTime? @map("used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiCall      AiCall?   @relation(fields: [aiCallId], references: [id])

  @@index([userId])
  @@index([expiresAt])
  @@map("payment_tokens")
}

model LeadSource {
  id          String    @id @default(cuid())
  userId      String?   @map("user_id")
  matterId    String?   @map("matter_id")
  aiCallId    String?   @map("ai_call_id")
  source      String
  channel     String?
  utmSource   String?   @map("utm_source")
  utmMedium   String?   @map("utm_medium")
  utmCampaign String?   @map("utm_campaign")
  utmContent  String?   @map("utm_content")
  referrerUrl String?   @map("referrer_url")
  landingPage String?   @map("landing_page")
  converted   Boolean   @default(false)
  convertedAt DateTime? @map("converted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  user        User?     @relation(fields: [userId], references: [id])
  aiCall      AiCall?   @relation(fields: [aiCallId], references: [id])

  @@index([userId])
  @@index([source])
  @@index([createdAt])
  @@map("lead_sources")
}

// ========================================
// EMAIL & SMS MANAGEMENT
// ========================================

model MessageTemplate {
  id                   String   @id @default(cuid())
  key                  String   @unique
  name                 String
  description          String?
  category             String   @default("transactional")
  emailSubject         String
  emailHtml            String   @db.Text
  emailPlainText       String?  @db.Text
  smsBody              String?
  smsEnabled           Boolean  @default(false)
  availableVariables   Json     @default("[]")
  variableDescriptions Json     @default("{}")
  active               Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([key])
  @@index([category])
  @@map("MessageTemplate")
}

model SmsLog {
  id           String   @id @default(cuid())
  matterId     String?
  to           String
  body         String
  templateKey  String?
  status       String   @default("sent")
  twilioSid    String?
  errorMessage String?
  meta         Json?
  createdAt    DateTime @default(now())
  matter       Matter?  @relation(fields: [matterId], references: [id], onDelete: SetNull)

  @@index([matterId])
  @@index([createdAt])
  @@map("SmsLog")
}

// ========================================
// MILESTONE CONFIRMATIONS (User Error Prevention)
// ========================================

model MilestoneConfirmation {
  id               String   @id @default(cuid())
  matterId         String
  milestoneType    String   // WILL_SEARCH_MAILED, P1_NOTICES_SENT, PROBATE_FILED, GRANT_RECEIVED
  confirmationType String   // BUTTON, TYPE_TO_CONFIRM, CHECKLIST
  confirmationData Json?    // { typedWord: "MAILED", checkedItems: [...] }
  confirmedAt      DateTime @default(now())
  ipAddress        String?
  userAgent        String?
  matter           Matter   @relation(fields: [matterId], references: [id], onDelete: Cascade)

  @@index([matterId])
  @@map("MilestoneConfirmation")
}

// ========================================
// VOICEMAIL (Incoming Call Fallback)
// ========================================

model Voicemail {
  id                  String    @id @default(cuid())
  callSid             String    @map("call_sid")
  callerPhone         String    @map("caller_phone")
  recordingUrl        String?   @map("recording_url")
  recordingSid        String?   @map("recording_sid")
  durationSeconds     Int?      @map("duration_seconds")
  transcription       String?   @db.Text
  transcriptionStatus String?   @map("transcription_status")
  reviewed            Boolean   @default(false)
  reviewedAt          DateTime? @map("reviewed_at")
  reviewedBy          String?   @map("reviewed_by")
  notes               String?   @db.Text
  createdAt           DateTime  @default(now()) @map("created_at")

  @@index([callSid])
  @@index([callerPhone])
  @@index([createdAt])
  @@index([reviewed])
  @@map("voicemails")
}
